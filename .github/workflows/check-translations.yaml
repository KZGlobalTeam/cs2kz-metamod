name: Translations checks

on:
  push:
    paths:
      - 'translations/cs2kz-*.phrases.txt'
      - 'translations/config.txt'
      - 'menu/*.txt'
      - 'scripts/check_translations.py'
      - '.github/workflows/check-translations.yaml'
  pull_request:
    paths:
      - 'translations/cs2kz-*.phrases.txt'
      - 'translations/config.txt'
      - 'menu/*.txt'
      - 'scripts/check_translations.py'
      - '.github/workflows/check-translations.yaml'

jobs:
  lint-translations:
    name: Lint Translation Files
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      - name: Get source commit info
        id: source
        run: |
          echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "message=$(git log -1 --pretty=%s | tr -d '"' | tr -d "'" | tr -d '`' | cut -c1-80)" >> "$GITHUB_OUTPUT"

      - name: Run translation linter
        id: lint
        run: |
          python scripts/check_translations.py . 2>&1 | tee translation-lint-results.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: translation-reports
          path: |
            translation-lint-results.txt
            missing-translations.txt
            missing-translations.json
          retention-days: 30

      - name: Push results to translation-reports branch
        if: always() && github.event_name == 'push' && github.ref == 'refs/heads/master'
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          COMMIT_SHA_FULL: ${{ steps.source.outputs.sha }}
          COMMIT_SHA: ${{ steps.source.outputs.sha_short }}
          COMMIT_MSG: ${{ steps.source.outputs.message }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Extract stats from missing-translations.txt
          TOTAL_LANGUAGES=$(grep "Total languages:" missing-translations.txt 2>/dev/null | awk '{print $NF}' || echo "0")
          TOTAL_PHRASES=$(grep "Total phrases:" missing-translations.txt 2>/dev/null | awk '{print $NF}' || echo "0")
          PHRASES_MISSING=$(grep "Phrases with missing translations:" missing-translations.txt 2>/dev/null | awk '{print $NF}' || echo "0")
          TOTAL_MISSING=$(grep "Total missing translation entries:" missing-translations.txt 2>/dev/null | awk '{print $NF}' || echo "0")

          # Extract phrase coverage section
          awk '/^LANGUAGE COVERAGE \(Phrases\)$/,/^Global languages/' missing-translations.txt | grep -E '^\s+\S+.*\[' > /tmp/coverage.txt 2>/dev/null || true

          if [ ! -s /tmp/coverage.txt ]; then
            echo "  No coverage data available" > /tmp/coverage.txt
          fi

          # Extract menu status section
          awk '/^MENU TRANSLATION STATUS$/,/^=/' missing-translations.txt | grep -E '^\s+\S+' > /tmp/menu_status.txt 2>/dev/null || true

          if [ ! -s /tmp/menu_status.txt ]; then
            echo "  No menu data available" > /tmp/menu_status.txt
          fi

          # Count menu stats from JSON
          MENU_COMPLETE=$(grep -c '"file_exists": true' missing-translations.json 2>/dev/null || echo "0")
          MENU_MISSING=$(grep -c '"file_exists": false' missing-translations.json 2>/dev/null || echo "0")
          MENU_TOTAL=$(ls -1 menu/*.txt 2>/dev/null | wc -l || echo "0")

          # Count errors and warnings
          ERRORS=$(grep -c "\[ERROR\]" translation-lint-results.txt 2>/dev/null || true)
          if [ -z "$ERRORS" ]; then ERRORS=0; fi

          WARNINGS=$(grep -c "\[WARNING\]" translation-lint-results.txt 2>/dev/null || true)
          if [ -z "$WARNINGS" ]; then WARNINGS=0; fi

          # Move report files to temp directory BEFORE switching branches
          mkdir -p /tmp/reports
          mv translation-lint-results.txt /tmp/reports/
          mv missing-translations.txt /tmp/reports/
          mv missing-translations.json /tmp/reports/

          # Switch to reports branch
          if git ls-remote --exit-code --heads origin translation-reports > /dev/null 2>&1; then
            git fetch origin translation-reports
            git checkout translation-reports
          else
            git checkout --orphan translation-reports
            git rm -rf . > /dev/null 2>&1 || true
          fi

          # Clean working directory and copy reports back
          rm -rf ./* 2>/dev/null || true
          cp /tmp/reports/* .

          # Read coverage and menu status into variables
          COVERAGE_SECTION=$(cat /tmp/coverage.txt)
          MENU_STATUS_SECTION=$(cat /tmp/menu_status.txt)

          # Create README with stats, graphs, and menu status
          cat > README.md << EOF
          # Translation Reports

          Automated translation linter reports for cs2kz-metamod.

          ## Status

          | Metric | Value |
          |--------|-------|
          | **Linter Errors** | ${ERRORS} |
          | **Linter Warnings** | ${WARNINGS} |
          | **Total Languages** | ${TOTAL_LANGUAGES} |
          | **Total Phrases** | ${TOTAL_PHRASES} |
          | **Phrases Missing Translations** | ${PHRASES_MISSING} |
          | **Total Missing Entries** | ${TOTAL_MISSING} |
          | **Menu Files** | ${MENU_TOTAL} |

          ## Language Coverage (Phrases)

          \`\`\`
          ${COVERAGE_SECTION}
          \`\`\`

          ## Menu Translation Status

          \`\`\`
          ${MENU_STATUS_SECTION}
          \`\`\`

          ## Reports

          | File | Description |
          |------|-------------|
          | [translation-lint-results.txt](translation-lint-results.txt) | Linter errors and warnings |
          | [missing-translations.txt](missing-translations.txt) | Detailed missing translations report |
          | [missing-translations.json](missing-translations.json) | Machine-readable JSON export |

          ## Last Updated

          - **Commit:** [\`${COMMIT_SHA}\`](https://github.com/${GITHUB_REPOSITORY}/commit/${COMMIT_SHA_FULL})
          - **Time:** ${TIMESTAMP}
          - **Message:** ${COMMIT_MSG}

          ---

          *This report is automatically generated on each push to master.*
          EOF

          # Commit and push
          git add -A
          git commit -m "Update translation reports

          Source: ${COMMIT_SHA} - ${COMMIT_MSG}" || echo "No changes to commit"
          git push origin translation-reports --force

      - name: Check for errors
        if: steps.lint.outputs.exit_code != '0'
        run: exit 1
